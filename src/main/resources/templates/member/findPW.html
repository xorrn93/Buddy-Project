<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</title>
    <script
            src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
            crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>

<h1>ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì–´ ë²„ë¦¬ì…¨ë‚˜ìš”?ğŸ˜¥</h1>
<form action="/email/sendPW" id="sendEmail">
  <input type="text" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" id="inputEmail" name="memberEmail">
   <button id="submitBtn" type="button">ì „ì†¡</button>
</form>
<script>
    document.querySelector('#submitBtn').addEventListener('click',function (){
        let userEmail = document.querySelector('#inputEmail').value;
        let sendEmail = document.querySelector('#sendEamil');
        const emailRegex = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
        if (emailRegex.test(userEmail)){
            $.ajax({
                url: "/member/idCheck",
                data: {
                    "id" : userEmail
                },error: function (){
                    alert('error!');
                }
            }).done( function(rsp){
                if (rsp === 'true'){
                    sendPW();
                }else {
                    alert("í•´ë‹¹ ì´ë©”ì¼ì˜ íšŒì›ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            })
        }else {
            alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ë°©ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        }
    })
    // ì´ë©”ì¼ ì„ì‹œë¹„ë°€ë²ˆí˜¸ ìƒì„±
    let tempPW;
    function getTempPW(){
        $.ajax({
            url: "/email/returnTempPW"
            ,type: "post"
            ,async: false
        }).done(function(rsp){
            tempPW = rsp;
        })
    }

    function sendPW() {
        getTempPW(); // ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ê°’
        let subject = "[Buddy] ì„ì‹œë¹„ë°€ë²ˆí˜¸ ì…ë‹ˆë‹¤";
        let body = tempPW;
        let userEmail = document.querySelector('#inputEmail').value
        // smtp íŒŒë¼ë¯¸í„° ê°’
        var params = {
            userId: userEmail,
            subject: subject,
            body: body
        }

        $.ajax({
            url: "/email/sendPW"
            , type: "POST"
            , accept: "application/json"
            , contentType: "application/json; charset=utf-8"
            , data: JSON.stringify(params)
            , dataType: "json"
            ,success: function(){
                alert(`${userEmail} ì£¼ì†Œë¡œ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³´ë‚´ë“œë ¸ìŠµë‹ˆë‹¤!`);
                history.back();
            }
            ,error: function () {
                alert("ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                location.reload();
            }
        })
    }
</script>
</body>
</html>