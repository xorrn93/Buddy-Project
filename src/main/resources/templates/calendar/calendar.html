<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'/>
    <script src='/static/fullcalendar/dist/index.global.js'></script>
    <script src="/static/fullcalendar/packages/core/locales-all.global.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.6.2.js"
            integrity="sha256-pkn2CUZmheSeyssYw3vMp1+xyub4m+e+QK4sQskvuo4="
            crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                themeSystem: 'bootstrap5',
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                locale: 'ko',
                weekday: 'short',
                day: 'short',
                selectable: true,
                selectMirror: true,
                dragScroll: true,
                navLinks: true,
                dayMaxEvents: true,
                nowIndicator: true,
                eventClick: function (arg) {
                    const seq = arg.event.extendedProps.seq; // ì´ë²¤íŠ¸ seq ê°’
                    const title = arg.event.title; // ì´ë²¤íŠ¸ ì œëª©
                    const writer = arg.event.extendedProps.writer; // ì‘ì„±ì
                    const type = arg.event.extendedProps.type; // íŒ€/ ê°œì¸ íƒ€ì…
                    const eventStart = arg.event._instance.range.start; // ì‹œì‘ë‚ ì§œ ë° ì‹œê°„
                    const eventEnd = arg.event._instance.range.end; // ë§ˆê°ë‚ ì§œ ë° ì‹œê°„
                    const memo = arg.event.extendedProps.memo; // ë©”ëª¨
                    const location = arg.event.extendedProps.location; // ì¥ì†Œ
                    const color = arg.event._def.ui.backgroundColor; // ì´ë²¤íŠ¸ ì»¬ëŸ¬ê°’
                    // ì• ë‹ˆë©”ì´ì…˜
                    $("#form").css("display", "block");
                    $(".btns").css("display", "block");
                    // ì´ë²¤íŠ¸ seq ë° ì‘ì„±ìëŠ” hidden ì²˜ë¦¬ ë˜ì–´ìˆìŒ
                    // controller ì—ì„œ ê°’ì„ ë„£ì–´ì£¼ê¸° ë•Œë¬¸ì— disabled ë¡œ ì²˜ë¦¬
                    $("#eventSeq").removeAttr("disabled");
                    $("#eventWriter").removeAttr("disabled");
                    $("#eventWriter").attr("type", "text");
                    //ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ìƒì„±
                    $("#updateBtn").css("display", "block");
                    $("#delBtn").css("display", "block");
                    $("#submitBtn").css("display", "none");
                    $("#closeBtn").css("display", "block");
                    // iso date value ë¥¼ í˜•ì‹ì— ë§ê²Œ ìˆ˜ì •
                    function timeFormat(t) {
                        return t.toISOString().substring(0, 16);
                    }
                    // ë°ì´í„° ëŒ€ì…
                    $("#eventType").val(type);
                    $("#eventSeq").val(seq);
                    // íƒ€ì…ì„ ë‚˜íƒ€ë‚´ëŠ” í…ìŠ¤íŠ¸ ì œì™¸
                    $("#eventName").val(title.replace("[íŒ€]", "").replace("[ê°œì¸]", ""));
                    $("#eventWriter").val(writer);
                    $("#eventMemo").val(memo);
                    $("#eventLocation").val(location);
                    $("#eventStart").attr("data-placeholder", timeFormat(eventStart));
                    $("#eventStart").val(timeFormat(eventStart));
                    $("#eventEnd").attr("data-placeholder", timeFormat(eventEnd));
                    $("#eventEnd").val(timeFormat(eventEnd));
                    $("#eventColor").val(color);
                    $("#eventColor").css("background-color", color);
                    $("#goMain").css("display","none");
                },
                // date click event ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
                dateClick: function (arg) {

                },
                select: function (arg) {
                    const start = arg.start
                    const end = arg.end
                    // date ë¥¼ timezone ì— ë§ê²Œ format
                    // date ëŠ” loacale ì— ì˜í–¥ì„ ë°›ê¸° ë•Œë¬¸ì— kor ì‹œê°„ìœ¼ë¡œ ì„¤ì • í•´ì¤˜ì•¼ í•¨
                    function timezoneFormat(d) {
                        let offset = d.getTimezoneOffset() * 60000;
                        // timezone Offset
                        let dateOffset = new Date(d.getTime() - offset);
                        // timezone Setting
                        let iso = dateOffset.toISOString();
                        // ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        return iso.substring(0, 16);
                    }
                    // date ë¥¼ í˜•ì‹ì— ë§ê²Œ format í•˜ëŠ” í•¨ìˆ˜
                    // ì›ì¸ : date typeì—ì„œ **ê¸°ê°„**ì„ ì„ íƒí• ë•Œ, í•˜ë£¨ê°€ ë” í•´ì ¸ì„œ ë‚˜ì˜´
                    // í•´ê²° : ì‹œê°„ì— í•˜ë£¨ë§Œí¼ì— ì‹œê°„ì„ ë¹¼ì¤˜ì„œ ì¶œë ¥
                    // input date type ì— value ë¥¼ ë„£ê¸° ìœ„í•´ì„œ ëŠ” IOS ë°©ì‹ìœ¼ë¡œ ë³€í™˜í•´ì•¼í•¨
                    function dateFormat(d) {
                        let offset = d.getTimezoneOffset() * 60000;
                        const day = 8.64e+7; // í•˜ë£¨ë§Œí¼ì— ì‹œê°„ì„ **ë°€ë¦¬ì´ˆ**ë‹¨ìœ„ë¡œ ê³„ì‚°í•œ ê°’
                        let dateOffset = new Date(d.getTime() - offset - day);
                        let iso = dateOffset.toISOString();
                        return iso.substring(0, 16);
                    }
                    let startFormat = timezoneFormat(start);
                    let endFormat = dateFormat(end);

                    $("#form").css("display", "block");
                    $(".btns").css("display", "block");
                    $("#updateBtn").css("display", "none");
                    $("#delBtn").css("display", "none");
                    $("#submitBtn").css("display", "block");
                    $("#closeBtn").css("display", "block");
                    $("#eventSeq").val("");
                    $("#eventType").val("íŒ€");
                    $("#eventName").val("");
                    $("#eventWriter").val("");
                    $("#eventWriter").attr("type", "hidden");
                    $("#eventLocation").val("");
                    $("#eventMemo").val("");
                    const defaultColor = "#8621F7";
                    $("#eventColor").val(defaultColor);
                    $("#eventColor").css("background-color", "#8621F7");

                    // month view ê°€ true ì¼ ë•Œë§Œ, date ê°’ì„ ì¡°ì •
                    // day view ë‚˜ week view ì—ì„œëŠ” date ê°’ì„ ì¡°ì •í•˜ì§€ ì•ŠìŒ,
                    // í•˜ë£¨ë§Œ ì„ íƒ í–ˆì„ë•Œë„ í•˜ë£¨ë§Œí¼ ì— ì‹œê°„ì´ ë¹ ì§€ê¸° ë•Œë¬¸
                    let monthViewTrue = $('button[title="ì›”"]').attr("aria-pressed");
                    // aria-pressed = true
                    if (monthViewTrue === "true") {
                        $("#eventStart").val(startFormat);
                        $("#eventEnd").val(endFormat);
                    }// aria-pressed = false
                    else {
                        $("#eventStart").val(startFormat);
                        $("#eventEnd").val(timezoneFormat(end));
                    }
                    $("#goMain").css("display","none");

                },

                unselect: function () {
                    $("#form").css("display", "block");
                    $("#updateBtn").css("display", "none");
                    $("#delBtn").css("display", "none");
                    $("#submitBtn").css("display", "block");
                    $("#eventSeq").val("");
                    $("#eventType").val("íŒ€");
                    $("#eventName").val("");
                    $("#eventWriter").val("");
                    $("#eventWriter").attr("type", "hidden");
                    $("#eventLocation").val("");
                    $("#eventMemo").val("");
                    $("#goMain").css("display","none");

                },
                // events object ì´ë²¤íŠ¸ ê°ì²´ [ì¼ì •ì˜ ë°ì´í„°ê°€ ë‹´ê¸°ëŠ” ê³µê°„ json íƒ€ì…]
                // ì´ë²¤íŠ¸ ì˜¤ë¸Œì íŠ¸ ì˜ˆì œ
                // events : [
                //     {
                //         id: 'a',
                //         title: 'my event',
                //         start: '2023-01-02',
                //         color: '#8621F7'
                //     }
                //
                // ]

                events: function (info, successCallback) {
                    $.ajax({
                        url: "/calendar/selectAll",
                        success: function (resp) {
                            const events = [];
                            let jsonParse = JSON.parse(resp);
                            $.each(jsonParse, function (index, element) {
                                events.push({
                                    seq: element.eventSeq,
                                    type: element.eventType,
                                    title: "[" + element.eventType + "]" + element.eventName,
                                    writer: element.eventWriter,
                                    location: element.eventLocation,
                                    memo: element.eventMemo,
                                    start: element.eventStart,
                                    end: element.eventEnd,
                                    color: element.eventColor
                                });

                            })
                            successCallback(events);
                        }
                        , error: function (request, status, error) {
                            alert("code:" + request.status + error);
                        }
                    });
                },
            })
            //ìº˜ë¦°ë” ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
            calendar.render();
        });
    </script>
    <link rel="stylesheet" href="/static/css/calendar.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Gothic+A1&family=Nanum+Gothic&family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <title>buddy ìº˜ë¦°ë”</title>
</head>
<body>
<div class="header">
    <img src="/static/img/logo_m2.png" class="logoImg">
    <h1>ìº˜ë¦°ë”</h1>
    <div class="headerBtns">
        <button onclick="location.href='/calendar/goTeam'" class="calType" id="goTeam">
            íŒ€
        </button>
        <button onclick="location.href='/calendar/goPrivate'" class="calType" id="goPrivate">
            ê°œì¸
        </button>
        <button onclick="location.href='/calendar/moveCalendar'" class="calType checked" id="goAll">
            ì „ì²´
        </button>

        <button class="plusBtn" style="display: none">+</button>
    </div>
</div>
<div class="wrap" style="clear: both">
    <div class="modal">
        <div class="modalWrap">

            <div class="inputEvent">

                <button id="formToggle" type="button" class="formToggle">
                    ì¼ì •ì¶”ê°€ +
                </button>


                <form action="/calendar/insertEvent" id="form" method="post">
                    <select name="eventColor" id="eventColor" class="eventSelect" onchange="selectColor(value)" data-placeholder="ìƒ‰ìƒ">
                        <option value="#8621F7" style="background: #8621F7" id="teamColor"></option>
                        <option value="#2CADF5" id="blue" style="background: #2CADF5"></option>
                        <option value="#FF5C00" id="red" style="background: #FF5C00"></option>
                        <option value="#06C102" id="green" style="background:#06C102"></option>
                        <option value="#545454"  id="black" style="background: #545454"></option>
                    </select>
                    <select name="eventType" id="eventType" class="eventSelect" >
                        <option value="íŒ€">íŒ€ ìº˜ë¦°ë”</option>
                        <option value="ê°œì¸">ê°œì¸ ìº˜ë¦°ë”</option>
                    </select>
                    <input type="hidden"  id="eventSeq" placeholder="seq" readonly disabled >
                    <input type="text" name="eventName" id="eventName" placeholder="ì œëª© (íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš©ë¶ˆê°€)">
                    <input type="hidden"  id="eventWriter" placeholder="ì‘ì„±ì" readonly disabled>
                    <input type="datetime-local" name="eventStart" id="eventStart"  data-placeholder="ì‹œì‘ë‚ ì§œ"  required aria-required="true">
                    <input type="datetime-local" name="eventEnd" id="eventEnd"  data-placeholder="ë§ˆê°ë‚ ì§œ" placeholder=""  required aria-required="true">
                    <input type="text" name="eventLocation" id="eventLocation" placeholder="ì¥ì†Œ (íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš©ë¶ˆê°€)">
                    <textarea name="eventMemo" id="eventMemo" cols="30" rows="10" placeholder="ë©”ëª¨"></textarea>
                    <button type="submit" id="submitBtn" class="modalBtn">
                        ì™„ë£Œ
                    </button>
                </form>
                <div class="btns" style="display: none">
                    <button type="submit" id="updateBtn" class="modalBtn" onclick="update()" style="display: none">ìˆ˜ì •</button>
                    <button type="submit" id="delBtn" class="modalBtn" onclick="del()" style="display: none">ì‚­ì œ</button>
                    <button type="button" id="closeBtn" class="modalBtn" onclick="window.location.reload()" >ì·¨ì†Œ</button>
                </div>
            </div>
        <button id="goMain"><a href="/member/loginIndex">ë©”ì¸ìœ¼ë¡œ</a></button>
        </div>
    </div>
    <!-- ìº˜ë¦°ë” ì˜ì—­-->
    <div id='calendar'>


    </div>
</div>
<script>
    // ìœ íš¨ì„± ê²€ì‚¬
    const eventNameRegex = /^[0-9a-zA-Zã„±-í£ ]{0,20}$/;
    const eventLocationRegex = /^[0-9a-zA-Zã„±-í£ ]{0,20}$/;
    const eventMemoRegex = /^[0-9a-zA-Zã„±-í£\{\}\[\]\/?.,;:\|\)*~`!^\-_+\<\>@\#$%&\\\=\(\'\"  ]{0,500}$/m;
    $("#eventName").keyup(function (){
        let result = eventNameRegex.test(this.value);
        if (!result){
            alert("ì¼ì • ì œëª©ì€ 20ì ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!ğŸ˜¥");
            this.value = "";
        }
    })
    $("#eventLocation").keyup(function (){
        let result = eventLocationRegex.test(this.value);
        if (!result){
            alert("ì¼ì • ì¥ì†ŒëŠ” 20ì ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!ğŸ˜¥");
            this.value = "";
        }
    })

    $("#eventMemo").keyup(function (){
        let result = eventMemoRegex.test(this.value);
        if (!result){
            alert("ì¼ì • ë©”ëª¨ëŠ” 500ì ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!ğŸ˜¥");
            this.value = "";
        }else {
            $(this).val().replace("<", "&lt;");
        }
    })



</script>
<script >
    $(document).ready(function (){
        console.log("DOMReadyPrintTest");
        // ì¼ì •ì¶”ê°€ í† ê¸€ ë™ì‘
        $("#formToggle").click(function (){
            $("#form").toggle();
            $(".btns").toggle();
            $("#goMain").css("display","block");
        });
    })

    // ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°
    function select() {
        location.href ="/calendar/selectAll";
    }
    // ì¼ì •ì‚­ì œ ê¸°ëŠ¥
    function del() {
        const seq = $("#eventSeq").val();
        const type =  $("#eventType").val();
        const writer = document.querySelector("#eventWriter").value;
        let title = $("#eventName").val();
        let queryStr = `/calendar/deleteEvent?eventSeq=${seq}&eventWriter=${writer}`;
        $("#eventWriter").attr("disabled",false);
        if (type === "ê°œì¸"){
            if (confirm("<"+title+">"+"ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                location.href = queryStr;
            }
        } else{
            if (confirm("<"+title+">"+"ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?,team")){
                location.href = queryStr;
            }
        }
        console.log(queryStr);
    }
    // ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
    function update() {
        $("#eventWriter").attr("disabled",false);
        const seq = $("#eventSeq").val();
        let type =$("#eventType").val();
        let title =$("#eventName").val();
        let eventStart =$("#eventStart").val();
        let eventEnd =$("#eventEnd").val();
        let eventLocation =$("#eventLocation").val();
        let eventMemo =$("#eventMemo").val();
        let eventColor = document.querySelector("#eventColor").value;
        const writer = document.querySelector("#eventWriter").value;
        // Query String
        let queryStr = `/calendar/teamEventUpd?eventSeq=${seq}&eventType=${type}&eventName=${title}&eventStart=${eventStart}&eventEnd=${eventEnd}&eventLocation=${eventLocation}&eventMemo=${eventMemo}&eventColor=${encodeURIComponent(eventColor)}&eventWriter=${writer}`;
        // íƒ€ì…ì´ íŒ€ ì´ë¼ë©´
        if(type === "íŒ€"){
            if (confirm("<"+title+">"+"ì¼ì •ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                location.href = queryStr;
            }

        }else {
            if (confirm("<"+title+">"+"ì¼ì •ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                location.href = queryStr;
            }
        }
        console.log(queryStr);
    }
    // evnetColor ê°’ì´ onchange ì‹œ value ì— ë”°ë¼ ë°°ê²½ìƒ‰ìƒ ë¶€ì—¬
    function selectColor(arg) {
        $("#eventColor").css("background",arg);
    }

</script>
</body>
</html>